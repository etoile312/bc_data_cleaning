"""
临床风格文本生成主逻辑模块。
负责构建提示词、调用LLM、生成临床风格文本。
"""

import json
import re
from typing import Dict, Any, Optional

from .preprocess_rules import preprocess_case_fields, random_name
from core.llm_api import call_llm

def build_prompt_v1(structured_case: Dict[str, Any]) -> str:
    """
    第一步：结构化转初稿，强调规则性和信息完整性。
    """
    return f"""你是一位肿瘤科主治医生，请根据下面的结构化数据，将所有有意义的医学信息用简洁、准确、专业的医学术语描述出来。不要遗漏任何重要信息，也不要添加无关内容。**只描述有意义的医学信息，不要添加"未见其他相关临床或病理信息记录"或类似兜底语句。**请严格遵循医学事实和字段规则进行转述。

**核心要求:**
1. **风格**: 专业、简洁、客观。
2. **结构**: 将相关信息（如诊断、手术、病理）组织成自然的段落，而不是简单地罗列数据。
3. **语言**: 使用医学术语，但要构成流畅的句子。

**关键转换指南 (必须遵守):**
- **正面肯定转述**:
  - `绝经状态: "是"` -> `"已绝经"`
  - `绝经状态: "否"` -> `"未绝经"`
  - `根治手术时间: "2020"` 结合 `已行根治手术: "是"` -> `"于2020年行根治手术"`
  - `复发时间: "2020"` 结合 `转移或复发: "是"` -> `"2020年复发"`

- **负面结果转述**:
  - `切缘阳性: "否"` -> `"切缘阴性"`
  - `远处转移: "否"` -> `"未见远处转移"`
  - `复发: "否"` -> `"无复发"`

- **省略原则 (非常重要)**:
  - 对于临床意义不大的阴性结果，**必须省略**。例如 `有新辅助治疗: "否"`，这类信息在多数情况下无需赘述。只记录关键的阳性发现和有意义的阴性发现。
  - 对于值为 `""` (空字符串), `null`, `无` 的字段，**一律不描述**。
  - 对于`是否`开头的字段，比如`是否保乳`，如果值为"是"，应直接描述事件，如"行保乳手术"或"进行保乳手术"，如果为"否"，则多数情况省略或用对立事件描述，如"进行根治手术，未保乳"或"进行改良根治术"。
  - **选项为"是否"的内容**: "是"或"否"都要在txt中体现，可以直接写，也可以根据标签中的规则间接体现（如"转移或复发"项，只要报告中有体现出转移或复发的内容，就不需要再描述"转移或复发"、"复发"这两项的内容；选项为空时才完全不提及）。

结构化病历如下（JSON）：
{json.dumps(structured_case, ensure_ascii=False, indent=2)}
"""

def build_prompt_v2(raw_text: str) -> str:
    """
    第二步：润色，重点给出风格、范例、表述习惯。
    """
    return f"""你是一位有丰富临床经验的肿瘤科主治医生。请将下面这段医学文本润色，使其表达更贴近真实医生书写风格。
- 用医生常用的书面表达方式，避免字段名+字段值的机械组合，尽量像医生写病历时的自然表达。
- 可以适当调整语序和表达，使其更流畅、更符合临床习惯。
- 只保留有意义的阳性/重要阴性结果，冗余信息省略。
- 事件性描述优先，字段名不出现在最终文本。
- 例如：
  - "脑、肝转移"（而不是"转移部位为脑、肝"）
  - "2023年5月复发"（而不是"复发时间为2023年5月"）
  - "术前肿块大小5cm，术后1cm"（只在第一项出现"肿块大小"字样）
  - "已绝经"、"行保乳手术"
- 病历撰写范例 (请严格参考其精炼风格):
  - (信息较全)王**，女，56岁，已绝经。2025年6月10日行"左乳癌改良根治术"，术后病理：浸润性导管癌（1.8cm），Ⅱ级，腋窝淋巴结转移（4/18），脉管侵犯（+），切缘阴性。免疫组化：ER(-), PR(-), HER-2(3+), FISH(+), Ki-67(40%)。术前未行新辅助治疗。术后复查未见远处转移。
  - (重点突出)张某，女，48岁，左乳癌术后3年，胸壁复发1年。既往史：胸壁复发时行THP方案治疗6周期达CR，停药8个月后再次出现肺转移。CT示胸壁结节2cm，新增肺结节1.2cm。病理：ER(-), PR(-), HER-2(3+), Ki-67(40%)。
  - (门诊记录风格)女，45岁，未绝经。左乳癌术后6年。2018年行左乳癌保乳术（pT1cN0M0, ⅠA期），ER(80%+)/PR(30%+)/HER-2(-)。辅助内分泌治疗5年。停药8个月后腹部MRI示肝S4/S8新发转移灶（最大2.8cm），病理示ER(70%+)/PR(10%+)/HER-2(-), Ki-67(20%)。
  - (简略摘要)赵某，女，62岁。右乳浸润性导管癌，cT2N1M0，IIB期。病理：ER(+), PR(+), HER2(-), Ki-67 30%。PS评分 1分。拟行新辅助化疗。

待润色文本：
{raw_text}
"""

def generate_clinical_text(case: Dict[str, Any]) -> str:
    """
    生成临床风格文本的主函数
    
    Args:
        case: 结构化病例数据
        
    Returns:
        生成的临床风格文本
    """
    # 添加随机姓名
    name = random_name()
    case_with_name = dict(case)
    case_with_name["患者"] = name
    
    # 预处理字段
    processed_case = preprocess_case_fields(case_with_name)
    
    # 第一步：结构化转初稿
    prompt1 = build_prompt_v1(processed_case)
    text_v1 = call_llm(prompt1)
    if text_v1:
        text_v1 = text_v1.replace("\\n", "\n")
        text_v1 = re.sub(r"。(?!(\n|$))", "。\n", text_v1)
    
    # 第二步：润色
    prompt2 = build_prompt_v2(text_v1)
    text_v2 = call_llm(prompt2)
    if text_v2:
        text_v2 = text_v2.replace("\\n", "\n")
        text_v2 = re.sub(r"。(?!(\n|$))", "。\n", text_v2)
    
    return text_v2 or text_v1 or ""

def process_single_case(case: Dict[str, Any], case_id: int) -> Dict[str, Any]:
    """
    处理单个病例，生成临床风格文本
    
    Args:
        case: 结构化病例数据
        case_id: 病例ID
        
    Returns:
        包含结构化数据和生成文本的字典
    """
    text = generate_clinical_text(case)
    
    return {
        "structured": case,
        "text": text
    } 